<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Direct Integration &mdash; CXP SearchHub 0.57.1 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
    <link rel="shortcut icon" href="../_static/favicon.jpg"/>
    <link rel="canonical" href="https://commerceexperts.github.io/searchhub-docs/smartquery/direct-integration.html" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="REST Service Integration" href="rest-service.html" />
    <link rel="prev" title="Common concepts and behavior" href="common.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #2B2D42" >
            <a href="../index.html">
            <img src="../_static/logo-searchhub.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../index.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ingestion.html">Ingestion</a></li>
<li class="toctree-l1"><a class="reference internal" href="../search-collector.html">Search Collector</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../module_smartquery.html">Module: SmartQuery</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="best-practices.html">Best Practices</a></li>
<li class="toctree-l2"><a class="reference internal" href="common.html">Common concepts and behavior</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Direct Integration</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#requirements">Requirements</a></li>
<li class="toctree-l3"><a class="reference internal" href="#maven-dependency">Maven Dependency</a></li>
<li class="toctree-l3"><a class="reference internal" href="#essential-usage">Essential Usage</a></li>
<li class="toctree-l3"><a class="reference internal" href="#usage-example">Usage Example</a></li>
<li class="toctree-l3"><a class="reference internal" href="#monitoring">Monitoring</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="rest-service.html">REST Service Integration</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../module_smartsuggest.html">Module: SmartSuggest</a></li>
<li class="toctree-l1"><a class="reference internal" href="../glossary.html">Glossary</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #2B2D42" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">CXP SearchHub</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a></li>
          <li class="breadcrumb-item"><a href="../module_smartquery.html">Module: SmartQuery</a></li>
      <li class="breadcrumb-item active">Direct Integration</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/smartquery/direct-integration.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="direct-integration">
<h1>Direct Integration<a class="headerlink" href="#direct-integration" title="Permalink to this heading">¶</a></h1>
<section id="requirements">
<h2>Requirements<a class="headerlink" href="#requirements" title="Permalink to this heading">¶</a></h2>
<ul class="simple">
<li><p>Java version &gt;=1.8</p></li>
<li><p>approximately, 200MB to 500MB additional Java Heapspace (depending on the amount of data to be managed)</p></li>
<li><p>If a firewall is used, it needs to be configured to allow connections to the following HTTPS Endpoints <a class="reference external" href="https://query.searchhub.io/">https://query.searchhub.io/</a> and <a class="reference external" href="https://import.searchhub.io/">https://import.searchhub.io/</a></p></li>
</ul>
</section>
<section id="maven-dependency">
<h2>Maven Dependency<a class="headerlink" href="#maven-dependency" title="Permalink to this heading">¶</a></h2>
<p>The SmartQuery library can be pulled as a maven dependency from our private repository <a class="reference external" href="https://nexus.commerce-experts.com/content/repositories/searchhub-external/">https://nexus.commerce-experts.com/content/repositories/searchhub-external/</a>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>&lt;dependency&gt;
    &lt;groupId&gt;io.searchhub&lt;/groupId&gt;
    &lt;artifactId&gt;smartquery&lt;/artifactId&gt;
    &lt;version&gt;1.2.7&lt;/version&gt;
&lt;/dependency&gt;

&lt;!-- ... --&gt;

&lt;repository&gt;
    &lt;id&gt;external-releases&lt;/id&gt;
    &lt;url&gt;https://nexus.commerce-experts.com/content/repositories/searchhub-external/&lt;/url&gt;
&lt;/repository&gt;
</pre></div>
</div>
</section>
<section id="essential-usage">
<h2>Essential Usage<a class="headerlink" href="#essential-usage" title="Permalink to this heading">¶</a></h2>
<p>The library contains the following three central types:</p>
<dl>
<dt>Tenant</dt><dd><p>Simple POJO that represents a single data domain. (See the <a class="reference external" href="../glossary.html">glossary</a> about what a <a class="reference external" href="../glossary.html#tenant">Tenant</a> is.)</p>
</dd>
<dt>QueryMapper</dt><dd><p>The central component provided by the SmartQuery library is the <cite>QueryMapper</cite>. It provides query mappings with the <cite>mapQuery</cite> method.</p>
<dl class="field-list simple">
<dt class="field-odd">QueryMapping mapQuery(String input)</dt>
<dd class="field-odd"><p>This method returns a query mapping, with the original user query, a mapped query and an optional redirect URL. A <cite>QueryMapping</cite> has some convenient methods to handle redirects and queries accordingly - please refer to the Javadoc.</p>
</dd>
</dl>
</dd>
<dt>QueryMapperManager</dt><dd><p>This class is responsible for initializing and managing the QueryMappers for the required Tenants. It needs to be instantiated with the provided API key <a class="footnote-reference brackets" href="#id2" id="id1">3</a>.
It’s <em>important</em> to use a single <cite>QueryMapperManager</cite> object, since it will internally spawn and manage several threads to update the <cite>QueryMapper</cite> instances asynchronously, and retain a reference to it.
If no longer needed, the <cite>close</cite> method should be called, to stop the internal update threads.</p>
<dl class="field-list">
<dt class="field-odd">QueryMapper getQueryMapper(Tenant t)</dt>
<dd class="field-odd"><p>The <cite>getQueryMapper</cite> method will always return the same instance of <cite>QueryMapper</cite> for the same given <cite>Tenant</cite>. As a result, it’s not necessary to keep a reference of the <cite>QueryMapper</cite>. However, keeping a reference of a <cite>QueryMapper</cite> instance isn’t a problem, since each <cite>QueryMapper</cite> will be updated in the background.</p>
<p>A non-existing tenant won’t cause an error but simply return a QueryMapper which always returns <cite>null</cite>.</p>
</dd>
</dl>
</dd>
</dl>
<dl class="footnote brackets">
<dt class="label" id="id2"><span class="brackets"><a class="fn-backref" href="#id1">3</a></span></dt>
<dd><p>We will provide you with a personal API Key.</p>
</dd>
</dl>
</section>
<section id="usage-example">
<h2>Usage Example<a class="headerlink" href="#usage-example" title="Permalink to this heading">¶</a></h2>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">private</span><span class="w"> </span><span class="n">QueryMapperManager</span><span class="w"> </span><span class="n">qmManager</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">QueryMapperManager</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span><span class="w"></span>
<span class="w">                                         </span><span class="p">.</span><span class="na">apiToken</span><span class="p">(</span><span class="s">&quot;YourApiKey&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">                                         </span><span class="p">.</span><span class="na">updateRate</span><span class="p">(</span><span class="mi">360</span><span class="p">)</span><span class="w">               </span><span class="c1">// optional</span><span class="w"></span>
<span class="w">                                         </span><span class="p">.</span><span class="na">preloadTenants</span><span class="p">(</span><span class="s">&quot;example.com&quot;</span><span class="p">)</span><span class="w"> </span><span class="c1">// optional</span><span class="w"></span>
<span class="w">                                         </span><span class="p">.</span><span class="na">build</span><span class="p">();</span><span class="w"></span>

<span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">searchProcess</span><span class="p">(</span><span class="n">HttpServletRequest</span><span class="w"> </span><span class="n">req</span><span class="p">,</span><span class="w"> </span><span class="n">HttpServletResponse</span><span class="w"> </span><span class="n">resp</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// init search process...</span><span class="w"></span>

<span class="w">    </span><span class="n">Tenant</span><span class="w"> </span><span class="n">tenant</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Tenant</span><span class="p">(</span><span class="s">&quot;example&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;com&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">QueryMapper</span><span class="w"> </span><span class="n">qm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">qmManager</span><span class="p">.</span><span class="na">getQueryMapper</span><span class="p">(</span><span class="n">tenant</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">searchQuery</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">req</span><span class="p">.</span><span class="na">getParameter</span><span class="p">(</span><span class="s">&quot;q&quot;</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">QueryMapping</span><span class="w"> </span><span class="n">mapping</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">qm</span><span class="p">.</span><span class="na">mapQuery</span><span class="p">(</span><span class="n">searchQuery</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mapping</span><span class="p">.</span><span class="na">hasRedirect</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">resp</span><span class="p">.</span><span class="na">setHeader</span><span class="p">(</span><span class="s">&quot;Location&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mapping</span><span class="p">.</span><span class="na">getRedirect</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="n">resp</span><span class="p">.</span><span class="na">setStatus</span><span class="p">(</span><span class="mi">302</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">searchQuery</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mapping</span><span class="p">.</span><span class="na">getSearchQuery</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="c1">// continue with search process...</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">// It&#39;s recommended to bind the qmManager instance to your JVM&#39;s lifecycle</span><span class="w"></span>
<span class="c1">// and close the QueryMapperManager during shutdown.</span><span class="w"></span>
<span class="c1">// Internally a ScheduledExecutorService is used, that will be stopped then.</span><span class="w"></span>
<span class="nd">@PreDestroy</span><span class="w"></span>
<span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">onJvmShutdown</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">qmManager</span><span class="p">.</span><span class="na">close</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>The Javadoc of the <code class="code docutils literal notranslate"><span class="pre">QueryMapperManager.builder()</span></code> methods tell you more about the available settings.</p>
</section>
<section id="monitoring">
<h2>Monitoring<a class="headerlink" href="#monitoring" title="Permalink to this heading">¶</a></h2>
<p>SmartQuery optionally exposes internal metrics using the <a class="reference external" href="https://micrometer.io/docs">Micrometer</a> framework. If you’d like to receive these metrics, add the desired Micrometer connector to your dependencies, as well as, the MeterRegistry implementation.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="c1">// ...</span><span class="w"></span>
<span class="n">MeterRegistry</span><span class="w"> </span><span class="n">meterRegistry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getYourMeterRegistryInstance</span><span class="p">();</span><span class="w"></span>

<span class="c1">// example: to expose metrics over JMX create a JmxMeterRegistry</span><span class="w"></span>
<span class="n">meterRegistry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">JmxMeterRegistry</span><span class="p">(</span><span class="n">JmxConfig</span><span class="p">.</span><span class="na">DEFAULT</span><span class="p">,</span><span class="w"> </span><span class="n">Clock</span><span class="p">.</span><span class="na">SYSTEM</span><span class="p">);</span><span class="w"></span>

<span class="c1">// and add it to the QueryMapperManager.builder afterwards</span><span class="w"></span>
<span class="n">queryMapperManagerBuilder</span><span class="p">.</span><span class="na">addMetricsRegistryAdapter</span><span class="p">(</span><span class="n">MeterRegistryAdapter</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">meterRegistry</span><span class="p">));</span><span class="w"></span>

<span class="c1">// ...</span><span class="w"></span>
</pre></div>
</div>
<p>Subsequently, you will be able to track the following metrics:</p>
<dl class="glossary simple">
<dt id="term-smartquery.statsCollector.queue.size">smartquery.statsCollector.queue.size<a class="headerlink" href="#term-smartquery.statsCollector.queue.size" title="Permalink to this term">¶</a></dt><dd><p>The current number of items inside the transmission queue of the stats-collector.
Since the queue size is limited to 500 entries per default, a higher value should never appear. Hitting this limit is an indicator of a broken connection to the stats API.</p>
</dd>
<dt id="term-smartquery.statsCollector.bulk.size.count">smartquery.statsCollector.bulk.size.count<a class="headerlink" href="#term-smartquery.statsCollector.bulk.size.count" title="Permalink to this term">¶</a></dt><dt id="term-smartquery.statsCollector.bulk.size.sum">smartquery.statsCollector.bulk.size.sum<a class="headerlink" href="#term-smartquery.statsCollector.bulk.size.sum" title="Permalink to this term">¶</a></dt><dt id="term-smartquery.statsCollector.bulk.size.max">smartquery.statsCollector.bulk.size.max<a class="headerlink" href="#term-smartquery.statsCollector.bulk.size.max" title="Permalink to this term">¶</a></dt><dd><p>The stats-collector’s bulk size metrics describe, how large the bulks are that were sent to the search|hub stats API.
With <code class="docutils literal notranslate"><span class="pre">sum/count</span></code> the average size can be calculated. Max is the biggest bulk since application start.</p>
</dd>
<dt id="term-smartquery.statsCollector.fail.count.total">smartquery.statsCollector.fail.count.total<a class="headerlink" href="#term-smartquery.statsCollector.fail.count.total" title="Permalink to this term">¶</a></dt><dd><p>The total amount of failed transmissions, that were reported to the stats API.</p>
</dd>
<dt id="term-smartquery.update.fail.count">smartquery.update.fail.count<a class="headerlink" href="#term-smartquery.update.fail.count" title="Permalink to this term">¶</a></dt><dd><p>The number of successive failed mapping update attempts for a certain tenant. If an update succeeds, this value will be reset to “0”.
If this value reaches “5”, that update process will be stopped and only started again, if mappings for the respective tenant are requested again.
This metric is tagged with the appropriate <cite>tenant_name</cite> and <cite>tenant_channel</cite>.</p>
</dd>
<dt id="term-smartquery.update.success.count.total">smartquery.update.success.count.total<a class="headerlink" href="#term-smartquery.update.success.count.total" title="Permalink to this term">¶</a></dt><dd><p>The total number of successful data updates per tenant.
This metric is tagged with the respective <cite>tenant_name</cite> and <cite>tenant_channel</cite>.</p>
</dd>
<dt id="term-smartquery.mappings.size">smartquery.mappings.size<a class="headerlink" href="#term-smartquery.mappings.size" title="Permalink to this term">¶</a></dt><dd><p>The current number of raw mapping pairs per tenant.
This metric is tagged with the respective <cite>tenant_name</cite> and <cite>tenant_channel</cite>.</p>
</dd>
<dt id="term-smartquery.mappings.age.seconds">smartquery.mappings.age.seconds<a class="headerlink" href="#term-smartquery.mappings.age.seconds" title="Permalink to this term">¶</a></dt><dd><p>Time passed, since the last successful mapping update.
This metric is tagged with the respective <cite>tenant_name</cite> and <cite>tenant_channel</cite>.</p>
</dd>
</dl>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="common.html" class="btn btn-neutral float-left" title="Common concepts and behavior" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="rest-service.html" class="btn btn-neutral float-right" title="REST Service Integration" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, CXP Commerce Experts GmbH.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>