<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Direct Integration &mdash; CXP SearchHub 0.63.3 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
    <link rel="shortcut icon" href="../_static/favicon.jpg"/>
    <link rel="canonical" href="https://commerceexperts.github.io/searchhub-docs/smartquery/direct-integration.html" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="REST Service Integration" href="rest-service.html" />
    <link rel="prev" title="Common concepts and behavior" href="common.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #2B2D42" >
            <a href="../index.html">
            <img src="../_static/logo-searchhub.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../index.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ingestion.html">Ingestion</a></li>
<li class="toctree-l1"><a class="reference internal" href="../search-collector.html">Search Collector</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../module_smartquery.html">Module: smartQuery</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="common.html">Common concepts and behavior</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Direct Integration</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#requirements">Requirements</a></li>
<li class="toctree-l3"><a class="reference internal" href="#maven-dependency">Maven Dependency</a></li>
<li class="toctree-l3"><a class="reference internal" href="#essential-usage">Essential Usage</a></li>
<li class="toctree-l3"><a class="reference internal" href="#usage-example">Usage Example</a></li>
<li class="toctree-l3"><a class="reference internal" href="#integration-with-sessionid">Integration with sessionID</a></li>
<li class="toctree-l3"><a class="reference internal" href="#monitoring">Monitoring</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="rest-service.html">REST Service Integration</a></li>
<li class="toctree-l2"><a class="reference internal" href="best-practices.html">Best Practices</a></li>
<li class="toctree-l2"><a class="reference internal" href="changelog.html">Changelog</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../module_smartsuggest.html">Module: smartSuggest</a></li>
<li class="toctree-l1"><a class="reference internal" href="../glossary.html">Glossary</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #2B2D42" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">CXP SearchHub</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a></li>
          <li class="breadcrumb-item"><a href="../module_smartquery.html">Module: smartQuery</a></li>
      <li class="breadcrumb-item active">Direct Integration</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/smartquery/direct-integration.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="direct-integration">
<h1>Direct Integration<a class="headerlink" href="#direct-integration" title="Permalink to this heading">¶</a></h1>
<section id="requirements">
<h2>Requirements<a class="headerlink" href="#requirements" title="Permalink to this heading">¶</a></h2>
<ul class="simple">
<li><p>Java version &gt;= 11</p></li>
<li><p>approximately, 120MB to 300MB additional Java Heapspace (depending on the amount of data to be managed)</p></li>
<li><p>If a firewall is used, it needs to be configured to allow connections to the following HTTPS endpoints: <a class="reference external" href="https://query.searchhub.io/">https://query.searchhub.io/</a> and <a class="reference external" href="https://import.searchhub.io/">https://import.searchhub.io/</a></p></li>
</ul>
</section>
<section id="maven-dependency">
<h2>Maven Dependency<a class="headerlink" href="#maven-dependency" title="Permalink to this heading">¶</a></h2>
<p>The smartQuery library can be pulled as a maven dependency from our private repository <a class="reference external" href="https://nexus.commerce-experts.com/content/repositories/searchhub-external/">https://nexus.commerce-experts.com/content/repositories/searchhub-external/</a>.</p>
<p>::
    &lt;dependency&gt;
        &lt;groupId&gt;io.searchhub&lt;/groupId&gt;
        &lt;artifactId&gt;smartquery&lt;/artifactId&gt;
        &lt;version&gt;2.3.0&lt;/version&gt;
    &lt;/dependency&gt;</p>
<p>    &lt;!– … –&gt;</p>
<p>    &lt;repository&gt;
        &lt;id&gt;external-releases&lt;/id&gt;
        &lt;url&gt;https://nexus.commerce-experts.com/content/repositories/searchhub-external/&lt;/url&gt;
    &lt;/repository&gt;</p>
</section>
<section id="essential-usage">
<h2>Essential Usage<a class="headerlink" href="#essential-usage" title="Permalink to this heading">¶</a></h2>
<p>The library contains the following three central types:</p>
<p>Tenant
  Simple POJO that represents a single data domain. (See the <a class="reference external" href="../glossary.html">glossary</a> about what a <a class="reference external" href="../glossary.html#tenant">Tenant</a> is.)</p>
<p>QueryMapper
  The central component provided by the smartQuery library is the <cite>QueryMapper</cite>. It provides query mappings with the <cite>mapQuery</cite> method.</p>
<p>  :QueryMapping mapQuery(String input):</p>
<p>    This method returns a query mapping, with the original user query, a mapped query and an optional redirect URL. A <cite>QueryMapping</cite> has some convenient methods to handle redirects and queries accordingly - please refer to the Javadoc.</p>
<p>QueryMapperManager
  This class is responsible for initializing and managing the QueryMappers for the required Tenants. It needs to be instantiated with the provided API key <a class="footnote-reference brackets" href="#id2" id="id1">3</a>.
  It’s <em>important</em> to use a single <cite>QueryMapperManager</cite> object since it will internally spawn and manage several threads to update the <cite>QueryMapper</cite> instances asynchronously, and retain a reference to it.
  If no longer needed, the <cite>close</cite> method should be called to stop the internal update threads.</p>
<p>  :QueryMapper getQueryMapper(Tenant t):</p>
<p>    The <cite>getQueryMapper</cite> method will always return the same instance of <cite>QueryMapper</cite> for the same given <cite>Tenant</cite>. As a result, it’s not necessary to keep a reference to the <cite>QueryMapper</cite>. However, keeping a reference to a <cite>QueryMapper</cite> instance isn’t a problem since each <cite>QueryMapper</cite> will be updated in the background.</p>
<p>    A non-existing tenant won’t cause an error but simply return a QueryMapper which always returns <cite>null</cite>.</p>
<p>    The API Key and the preload tenants are automatically populated with the same environment variables as the REST-service:
    If the environment variable <cite>SH_API_KEY</cite> is available, the API Key is set to it. Same for <cite>SH_INIT_TENANTS</cite> that adds tenants to the list of preloaded tenants.</p>
<dl class="footnote brackets">
<dt class="label" id="id2"><span class="brackets"><a class="fn-backref" href="#id1">3</a></span></dt>
<dd><p>We will provide you with a personal API Key.</p>
</dd>
</dl>
</section>
<section id="usage-example">
<h2>Usage Example<a class="headerlink" href="#usage-example" title="Permalink to this heading">¶</a></h2>
<p>  .. code-block:: java</p>
<p>    private QueryMapperManager qmManager = QueryMapperManager.builder()
                                             .apiToken(“YourApiKey”)
                                             .updateRate(360)               // optional
                                             .preloadTenants(“example.com”) // optional
                                             .build();</p>
<p>    public void searchProcess(HttpServletRequest req, HttpServletResponse resp)
    {
        // init search process…</p>
<p>        Tenant tenant = new Tenant(“example”, “com”);
        QueryMapper qm = qmManager.getQueryMapper(tenant);</p>
<p>        String searchQuery = req.getParameter(“q”);</p>
<p>        // in case the session-id of the searchHub collector is given, it should be used here.
        // If not, stick with ‘null’ because a different session leads to unwanted results!
        QueryMapping mapping = qm.mapQuery(searchQuery, req.getCookieValue(“SearchCollectorSession”));
        if (mapping.hasRedirect()) {
            resp.setHeader(“Location”, mapping.getRedirect());
            resp.setStatus(302);
            return;
        } else {
            searchQuery = mapping.getSearchQuery();
        }</p>
<p>        // continue with search process…
    }</p>
<p>    // It’s recommended to bind the qmManager instance to your JVM’s lifecycle
    // and close the QueryMapperManager during shutdown.
    // Internally a ScheduledExecutorService is used, that will be stopped then.
    &#64;PreDestroy
    public void onJvmShutdown() {
        qmManager.close();
    }</p>
<p>The Javadoc of the <code class="code docutils literal notranslate"><span class="pre">QueryMapperManager.builder()</span></code> methods tell you more about the available settings.</p>
</section>
<section id="integration-with-sessionid">
<h2>Integration with sessionID<a class="headerlink" href="#integration-with-sessionid" title="Permalink to this heading">¶</a></h2>
<p>If our <a class="reference external" href="search-collector.html">search collector</a> is integrated into the frontend of your system, it is recommended to pass the corresponding sessionId to smartQuery.
This sessionId is used for clusters with queries being tested to distribute the search traffic evenly between both queries.
Without the sessionId, the informative value and success rate of these tests are lower.</p>
<p>For implementation, the value of the <code class="code docutils literal notranslate"><span class="pre">SearchCollectorSession</span></code> cookie <em>MUST</em> be used. Using a different sessionId will lead to unexpected results.
If the <code class="code docutils literal notranslate"><span class="pre">SearchCollectorSession</span></code> cookie does not exist or is not provided for a request, pass ‘null’ instead.</p>
<p>More information about this extended integration is in the <a class="reference external" href="best-practice.html">best practice</a> section.</p>
</section>
<section id="monitoring">
<h2>Monitoring<a class="headerlink" href="#monitoring" title="Permalink to this heading">¶</a></h2>
<p>smartQuery optionally exposes internal metrics using the <a class="reference external" href="https://micrometer.io/docs">Micrometer</a> framework. If you’d like to receive these metrics, add the desired Micrometer connector to your dependencies, as well as the MeterRegistry implementation.</p>
<p>  .. code-block:: java</p>
<p>    // …
    MeterRegistry meterRegistry = getYourMeterRegistryInstance();</p>
<blockquote>
<div><p>// Example: To expose metrics over JMX, create a JmxMeterRegistry</p>
</div></blockquote>
<p>    meterRegistry = new JmxMeterRegistry(JmxConfig.DEFAULT, Clock.SYSTEM);</p>
<p>    // and add it to the QueryMapperManager.builder afterwards
    queryMapperManagerBuilder.addMetricsRegistryAdapter(MeterRegistryAdapter.of(meterRegistry));</p>
<p>    // …</p>
<p>Subsequently, you will be able to track the following metrics:</p>
<dl class="glossary simple">
</dl>
<p>    smartquery.statsCollector.queue.size
        The current number of items inside the transmission queue of the stats-collector.
        Since the queue size is limited to 500 entries per default, a higher value should never appear. Hitting this limit is an indicator of a broken connection to the stats API.</p>
<p>    smartquery.statsCollector.bulk.size.count
    smartquery.statsCollector.bulk.size.sum
    smartquery.statsCollector.bulk.size.max
        The stats-collector’s bulk size metrics describe how large the bulks are that were sent to the searchHub stats API.
        With <code class="docutils literal notranslate"><span class="pre">sum/count</span></code> the average size can be calculated. Max is the biggest bulk since the application started.</p>
<p>    smartquery.statsCollector.fail.count.total
        The total amount of failed transmissions, that were reported to the stats API.</p>
<p>    smartquery.update.fail.count
        The number of successive failed mapping update attempts for a certain tenant. If an update succeeds, this value will be reset to “0”.
        If this value reaches “5”, that update process will be stopped and only started again if mappings for the respective tenant are requested once more.
        This metric is tagged with the appropriate <cite>tenant_name</cite> and <cite>tenant_channel</cite>.</p>
<p>    smartquery.update.success.count.total
        The total number of successful data updates per tenant.
        This metric is tagged with the respective <cite>tenant_name</cite> and <cite>tenant_channel</cite>.</p>
<p>    smartquery.mappings.size
        The current number of raw mapping pairs per tenant.
        This metric is tagged with the respective <cite>tenant_name</cite> and <cite>tenant_channel</cite>.</p>
<p>    smartquery.mappings.age.seconds
        Time passed since the last successful mapping update.
        This metric is tagged with the respective <cite>tenant_name</cite> and <cite>tenant_channel</cite>.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="common.html" class="btn btn-neutral float-left" title="Common concepts and behavior" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="rest-service.html" class="btn btn-neutral float-right" title="REST Service Integration" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, CXP Commerce Experts GmbH.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>