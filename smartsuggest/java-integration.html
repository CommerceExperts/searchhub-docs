

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Java Integration &mdash; CXP SearchHub 0.63.3 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=afbf3d36" />

  
    <link rel="shortcut icon" href="../_static/favicon.jpg"/>
    <link rel="canonical" href="https://commerceexperts.github.io/searchhub-docs/smartsuggest/java-integration.html" />
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=5bb3c584"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Changelog" href="changelog.html" />
    <link rel="prev" title="Service Operations" href="service-operations.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #2B2D42" >

          
          
          <a href="../index.html">
            
              <img src="../_static/logo-searchhub.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../integration-guide.html">Integration Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ingestion.html">Ingestion</a></li>
<li class="toctree-l1"><a class="reference internal" href="../search-collector.html">Search Collector</a></li>
<li class="toctree-l1"><a class="reference internal" href="../module_smartquery.html">Module: smartQuery</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../module_smartsuggest.html">Module: smartSuggest</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="user-stories.html">User Stories</a></li>
<li class="toctree-l2"><a class="reference internal" href="setup.html">Setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="service-integration.html">Service Integration</a></li>
<li class="toctree-l2"><a class="reference internal" href="service-operations.html">Service Operations</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Java Integration</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#dependencies">Dependencies</a></li>
<li class="toctree-l3"><a class="reference internal" href="#initialization">Initialization</a></li>
<li class="toctree-l3"><a class="reference internal" href="#general-configuration">General Configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="#suggestconfig">SuggestConfig</a></li>
<li class="toctree-l3"><a class="reference internal" href="#adding-custom-data">Adding Custom Data</a></li>
<li class="toctree-l3"><a class="reference internal" href="#monitoring">Monitoring</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="changelog.html">Changelog</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../operations.html">Common Operations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../glossary.html">Glossary</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #2B2D42" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">CXP SearchHub</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../module_smartsuggest.html">Module: smartSuggest</a></li>
      <li class="breadcrumb-item active">Java Integration</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/smartsuggest/java-integration.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="java-integration">
<h1>Java Integration<a class="headerlink" href="#java-integration" title="Link to this heading"></a></h1>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The <a class="reference internal" href="#java-integration">Java integration</a> is only recommended in the case you want to combine it with your existing suggest service or extend the suggest service with more custom data source. And of course it’s only possible if your service is running inside a JVM environment.</p>
<p>Also keep in mind that you have to take care of the service providing those suggestions.</p>
<p>For a simple frontend integration, please consider using the <a class="reference external" href="service-integration.html">service integration</a>.</p>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">QuerySuggester</span></code> is the central object of the smartSuggest library. It is used to fetch the matching suggestions based on the (partial) user input.
To get access to a <code class="docutils literal notranslate"><span class="pre">QuerySuggester</span></code> object, a single <code class="docutils literal notranslate"><span class="pre">QuerySuggestManager</span></code> must be initialized and maintained as a central reference.
This is important as the QuerySuggestManager instance takes care of updating the suggest data in case the data changes at the data-source.
It can also be used to shutdown any <code class="docutils literal notranslate"><span class="pre">QuerySuggesters</span></code> and therefore free related resources.</p>
<p>A <code class="docutils literal notranslate"><span class="pre">QuerySuggester</span></code> instance can be accessed from the <code class="docutils literal notranslate"><span class="pre">QuerySuggestManager</span></code> using an “index name” as a parameter.
The index name is the full <a class="reference external" href="../glossary.html">tenant</a> name used at searchHub. For example: “myshop.com”.</p>
<p>Alternatively you can specify index name to tenant mappings via ENV variable “SH_TENANT_MAPPINGS” or system property “searchhub.tenant_mappings”.
Their value should be a comma separated list of key value pairs. Example: SH_TENANT_MAPPINGS=”indexname=tenant.name,myshop=myshop.com”</p>
<p>To load the correct data, the update process must get your searchHub API key, which you will receive during searchHub onboarding.
This API key must be set either, as environment variable “SH_API_KEY” or, as system property “searchhub.apikey” within the Java environment.</p>
<section id="dependencies">
<h2>Dependencies<a class="headerlink" href="#dependencies" title="Link to this heading"></a></h2>
<p>The basic smartSuggest library is part of the Open-Commerce-Search stack, therefor the dependency is <code class="docutils literal notranslate"><span class="pre">de.cxp.ocs::smartsuggest-lib</span></code>.
In order to load the searchHub data, our <code class="docutils literal notranslate"><span class="pre">searchhub-suggest-data-provider</span></code> must be added to the classpath as well.
All related components can be pulled as a maven dependency from <a class="reference external" href="https://nexus.commerce-experts.com/content/repositories/searchhub-external/">our repository</a></p>
<div class="highlight-XML notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;dependency&gt;</span>
<span class="w">    </span><span class="nt">&lt;groupId&gt;</span>de.cxp.ocs<span class="nt">&lt;/groupId&gt;</span>
<span class="w">    </span><span class="nt">&lt;artifactId&gt;</span>smartsuggest-lib<span class="nt">&lt;/artifactId&gt;</span>
<span class="w">    </span><span class="nt">&lt;version&gt;</span>0.23.1<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
<span class="w">    </span><span class="nt">&lt;groupId&gt;</span>io.searchhub<span class="nt">&lt;/groupId&gt;</span>
<span class="w">    </span><span class="nt">&lt;artifactId&gt;</span>searchhub-suggest-data-provider<span class="nt">&lt;/artifactId&gt;</span>
<span class="w">    </span><span class="nt">&lt;version&gt;</span>1.4.2<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>

<span class="cm">&lt;!-- ... --&gt;</span>

<span class="nt">&lt;repository&gt;</span>
<span class="w">    </span><span class="nt">&lt;id&gt;</span>external-releases<span class="nt">&lt;/id&gt;</span>
<span class="w">    </span><span class="nt">&lt;url&gt;</span>https://nexus.commerce-experts.com/content/repositories/searchhub-external/<span class="nt">&lt;/url&gt;</span>
<span class="nt">&lt;/repository&gt;</span>
</pre></div>
</div>
</section>
<section id="initialization">
<h2>Initialization<a class="headerlink" href="#initialization" title="Link to this heading"></a></h2>
<p>This example code should just show how the Suggester can be initialized. Depending on your application architecture you should wrap it inside a Service implementation and build
your controller endpoints.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">static</span><span class="w"> </span><span class="n">QuerySuggestManager</span><span class="w"> </span><span class="n">qsm</span><span class="p">;</span>
<span class="kd">static</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// as the &#39;searchhub-suggest-data-provider&#39; is loaded via the Java SPI system</span>
<span class="w">        </span><span class="c1">// you cannot configure it directly. The required settings have to be set as</span>
<span class="w">        </span><span class="c1">// system properties (Setting them directly is not recommended, we just do it for</span>
<span class="w">        </span><span class="c1">// demonstration purposes)</span>
<span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">setProperty</span><span class="p">(</span><span class="s">&quot;searchhub.apikey&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;123abc&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">setProperty</span><span class="p">(</span><span class="s">&quot;searchhub.tenant_mappings&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;example=example.com&quot;</span><span class="p">);</span>

<span class="w">        </span><span class="n">qsm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">QuerySuggestManager</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>
<span class="w">                </span><span class="c1">// required for lucene where it puts the index files</span>
<span class="w">                </span><span class="p">.</span><span class="na">indexFolder</span><span class="p">(</span><span class="n">Files</span><span class="p">.</span><span class="na">createTempDirectory</span><span class="p">(</span><span class="s">&quot;smartsuggest&quot;</span><span class="p">))</span>
<span class="w">                </span><span class="c1">// force synchronous indexation (optional)</span>
<span class="w">                </span><span class="p">.</span><span class="na">preloadIndexes</span><span class="p">(</span><span class="s">&quot;example.com&quot;</span><span class="p">)</span>
<span class="w">                </span><span class="c1">// the builder also has other options</span>
<span class="w">                </span><span class="p">.</span><span class="na">build</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UncheckedIOException</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// It&#39;s recommended to bind the querySuggestManager instance to your JVM&#39;s lifecycle</span>
<span class="c1">// and close the QueryMapperManager during shutdown.</span>
<span class="c1">// Internally a ScheduledExecutorService is used, that will be stopped then.</span>
<span class="nd">@PreDestroy</span>
<span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">onJvmShutdown</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">qsm</span><span class="p">.</span><span class="na">close</span><span class="p">();</span>
<span class="p">}</span>

<span class="kd">private</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">suggestQueries</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">userQuery</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">maxSuggestions</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">qsm</span><span class="p">.</span><span class="na">getQuerySuggester</span><span class="p">(</span><span class="s">&quot;example&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="na">suggest</span><span class="p">(</span><span class="n">userQuery</span><span class="p">,</span><span class="w"> </span><span class="n">maxSuggestions</span><span class="p">,</span><span class="w"> </span><span class="n">Collections</span><span class="p">.</span><span class="na">emptySet</span><span class="p">())</span>
<span class="w">            </span><span class="p">.</span><span class="na">stream</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">suggestion</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">suggestion</span><span class="p">.</span><span class="na">getLabel</span><span class="p">())</span>
<span class="w">            </span><span class="p">.</span><span class="na">collect</span><span class="p">(</span><span class="n">Collectors</span><span class="p">.</span><span class="na">toList</span><span class="p">());</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The javadoc of the <code class="code docutils literal notranslate"><span class="pre">QuerySuggestManager.builder()</span></code> methods tell you more about the available settings.</p>
<p>The last parameter of the ‘suggest’ method (type ‘Set’ where at this example simply ‘Collections.emptySet()’ is passed) is there for filtering suggestions according to their tags.
However the data from searchHub is not tagged yet, so any non-empty parameter will lead to 0 result. This feature is for later usage.</p>
</section>
<section id="general-configuration">
<h2>General Configuration<a class="headerlink" href="#general-configuration" title="Link to this heading"></a></h2>
<p>When building a QuerySuggestManager - the central object that build and holds the QuerySuggest instances for all indexes - there are several options that can be set to change the default behaviour:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">QuerySuggestManager</span><span class="w"> </span><span class="n">querySuggestManager</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">QuerySuggestManager</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * Since the index directory is not cleaned up after index closing, it could be useful</span>
<span class="cm">     * to use the same directory all the time, so that existing files are reused and overwritten.</span>
<span class="cm">     * If this index folder is not specified, a random temporary folder is picked.</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="p">.</span><span class="na">indexFolder</span><span class="p">(</span><span class="n">Files</span><span class="p">.</span><span class="na">createDirectory</span><span class="p">(</span><span class="n">Path</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="s">&quot;/tmp/suggest-index-dir&quot;</span><span class="p">)))</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * To load indexes directly after initialization, specify them here</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="p">.</span><span class="na">preloadIndexes</span><span class="p">(</span><span class="s">&quot;my.tenant_1&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;my.tenant_2&quot;</span><span class="p">)</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * Overwrite the default of 60 seconds update rate. Min = 5 / Max = 3600</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="p">.</span><span class="na">updateRate</span><span class="p">(</span><span class="mi">120</span><span class="p">)</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * Attach a meter registry to the suggest manager and all QuerySuggester produced by it</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="p">.</span><span class="na">addMetricsRegistryAdapter</span><span class="p">(</span><span class="n">MeterRegistryAdapter</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">JmxMeterRegistry</span><span class="p">(</span><span class="n">config</span><span class="p">,</span><span class="w"> </span><span class="n">clock</span><span class="p">)))</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * Customize default configuration that is used as a basis for other configs provided by</span>
<span class="cm">     * a potential SuggestConfigProvider (that can be added via the standard java ServiceLoader)</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="p">.</span><span class="na">withDefaultSuggestConfig</span><span class="p">(</span><span class="n">SuggestConfig</span><span class="p">.</span><span class="na">builder</span><span class="p">().</span><span class="na">alwaysDoFuzzy</span><span class="p">(</span><span class="kc">false</span><span class="p">).</span><span class="na">maxSharpenedQueries</span><span class="p">(</span><span class="mi">5</span><span class="p">).</span><span class="na">build</span><span class="p">())</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * A custom SuggestDataProvider can either be injected using the standard java ServiceLoader mechanic</span>
<span class="cm">     * (declaring a implementation for de.cxp.ocs.smartsuggest.spi.SuggestDataProvider)</span>
<span class="cm">     * or by passing an instance directly to the builder. Do not use both mechanics, otherwise that</span>
<span class="cm">     * data-provider is loaded twice.</span>
<span class="cm">     **/</span>
<span class="w">    </span><span class="p">.</span><span class="na">withSuggestDataProvider</span><span class="p">(</span><span class="n">mySuggestDataProvider</span><span class="p">)</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * Data provider configs are class specific, so the same config will be passed to each instance that has</span>
<span class="cm">     * data for a requested index.</span>
<span class="cm">     * If there should be two different data providers of the same class, make sure to pass individual parameters</span>
<span class="cm">     * during instance creation. The data provider config will be passed additionally.</span>
<span class="cm">     * This is useful for general connection settings for example.</span>
<span class="cm">     **/</span>
<span class="w">    </span><span class="p">.</span><span class="na">addDataProviderConfig</span><span class="p">(</span><span class="n">mySuggestDataProvider</span><span class="p">.</span><span class="na">getClass</span><span class="p">().</span><span class="na">getCanonicalName</span><span class="p">(),</span><span class="w"> </span><span class="n">singletonMap</span><span class="p">(</span><span class="s">&quot;my-setting&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;value&quot;</span><span class="p">))</span>

<span class="w">    </span><span class="p">.</span><span class="na">build</span><span class="p">();</span>
</pre></div>
</div>
</section>
<section id="suggestconfig">
<h2>SuggestConfig<a class="headerlink" href="#suggestconfig" title="Link to this heading"></a></h2>
<p>The simplest way is to set a static default configuration during <code class="code docutils literal notranslate"><span class="pre">QuerySuggestManager</span></code> setup by using the method <code class="code docutils literal notranslate"><span class="pre">withDefaultSuggestConfig</span></code> and setting an object of type <code class="code docutils literal notranslate"><span class="pre">de.cxp.ocs.smartsuggest.spi.SuggestConfig</span></code>. It allows several changes about how the suggest library will behave. All of them described in detail below.</p>
<p>Another possibility is the injection of a <code class="code docutils literal notranslate"><span class="pre">SuggestDataProvider</span></code> implementation by using Java Service-Loader mechanic. Therefor you need the file on classpath named <code class="code docutils literal notranslate"><span class="pre">META-INF.services/de.cxp.ocs.smartsuggest.spi.SuggestDataProvider</span></code> that contains the full canonical class-name of your custom implementation. That custom implementation also needs be on classpath and have a no-args-constructor.
This option comes in handy when you have index-specific configuration or if you want to load configuration dynamically from an external resource or database. The implementation is then asked for a configuration object everytime new data is loaded.</p>
<p>Here a full description of all configuration properties. The names in brackets are the for <code class="docutils literal notranslate"><span class="pre">suggest.properties</span></code> file in case the standard implementation <code class="code docutils literal notranslate"><span class="pre">SuggestServiceProperties</span></code> is used.</p>
<blockquote>
<div><ul class="simple">
<li><p>locale (suggest.locale): the locale for a index to be used. Relevant for normalization of the indexed text.</p></li>
<li><p>alwaysDoFuzzy (suggest.always-do-fuzzy): if set to true, a fuzzy lookup is made even when some exact prefix-matches are found.
This will increase the average lookup time and should only be done in case of bad data or many ambiguous matches.
If not set, fuzzy-lookup are only done for input terms that don’t match any text as an exact prefix.</p></li>
<li><dl class="simple">
<dt>sortStrategy (suggest.sort-strategy): can be one of ‘PrimaryAndSecondaryByWeight’ or ‘MatchGroupsSeparated’</dt><dd><ul>
<li><p>MatchGroupsSeparated: Suggestions are ordered by their match-group (sharpened, primary, secondary, fuzzy1, fuzzy2, etc).
Within each group, matches are ordered according to “best match” (a combination of match-position and weight).</p></li>
<li><p>PrimaryAndSecondaryByWeight: Similar to MatchGroupsSeparated, but “primary” and “secondary” group are considered equal and merged.
Within these first match groups, suggestions are only ordered by weight.</p></li>
</ul>
</dd>
</dl>
</li>
<li><p>maxSharpenedQueries (suggest.max-sharpened-queries): Defines the limit of returned sharpened queries.
Sharpened queries are queries that are injected directly (without requesting a Lucene index) from a hash-map if
the input query matches one of the existing entries.
This limit is only considered if there are more sharpened queries than defined by that limit.</p></li>
<li><p>isIndexConcurrently (suggest.concurrent-indexation): If set to false, the indexation of the received data will be done sequentially.
This means it will take longer until the service is ready for usage and will spare computational power that might be used for others.</p></li>
<li><p>useDataSourceMerger (suggest.data-source-merger): boolean value that only is required if there are several data-sources. If set to true, those data is merged and
indexed into one index. This could reduce load and improve performance since a single Lucene suggester is asked for results.
However in such a case the weights should be in a similar range to avoid a proper ranking.</p></li>
<li><p>groupKey (suggest.group.key): With this setting it is possible to specify a key that is available in the payload of all provided suggestions.
The final result list will then be grouped by this payload-value and truncated according to the provided group configs.
It’s recommended to use setGroupConfig as well, otherwise the default limiter will be used after grouping.</p></li>
<li><p>groupConfig (either ‘suggest.group.share-conf’ or ‘suggest.group.cutoff-conf’ if relative or absolute values should be used):
An ordered list of string-integer tuples. Each string refers to a value of the group-key.
It defines the amount of suggestions to return as a maximums for a single suggest-result-list,
e.g. max 4 brand-suggestions and max. 6 category suggestions</p></li>
<li><p>useRelativeShareLimit (already reflected in the use of suggest.group.share-conf):
This changes the meaning of the groupConfig values. If set to true the group-configs are used as relative share values,
for example 20 and 80 are treated as 20% and 80%.</p></li>
<li><p>groupDeduplicationOrder (suggest.group.deduplication-order): Defines in which order similar suggestions from different “groups” are preferred.
Names that appear first are preferred over names appearing later. This setting is ‘null’ per default, which means no
deduplication is done at all. If an empty String[] is set, deduplication is done randomly.
This only works, if the suggest service is configured with a grouping key.</p></li>
<li><p>prefetchLimitFactor (suggest.group.prefetch-limit-factor): If grouping and limiting is configured by a key that comes from a single or merged data-provider, then this value
can be used to increase the internal amount of fetched suggestions.
This is usable to increase the likeliness to get the desired group counts.</p></li>
</ul>
</div></blockquote>
</section>
<section id="adding-custom-data">
<h2>Adding Custom Data<a class="headerlink" href="#adding-custom-data" title="Link to this heading"></a></h2>
<p>The Suggest Library is build as service that takes care of updates on its own. So no external process is necessary to send data to the Suggest Library. Instead a <code class="code docutils literal notranslate"><span class="pre">SuggestDataProvider</span></code> implementation is required, that encapsulates all the data loading. Check the <a class="reference internal" href="#suggestconfig"><span class="std std-ref">SuggestConfig</span></a> section above about how to add a custom <code class="code docutils literal notranslate"><span class="pre">SuggestDataProvider</span></code> to the suggest service.</p>
<p>Let’s assume you have a database where your required data is managed and updated every now and then. Your <code class="code docutils literal notranslate"><span class="pre">SuggestDataProvider</span></code> implementation needs to provide two pieces of information in advance:</p>
<blockquote>
<div><ul class="simple">
<li><p>Is there data for a given index?</p></li>
<li><p>What is the last time, this data was modified?</p></li>
</ul>
</div></blockquote>
<p>The modification time of your data is important, because the Suggest Library will only request the data itself, if it is not indexed yet or if the indexed data is older than the indexed data. The check for new data is done every minute by default and can be changed with the <code class="code docutils literal notranslate"><span class="pre">updateRate</span></code> setting of the <code class="code docutils literal notranslate"><span class="pre">QuerySuggestManagerBuilder</span></code>. If there is no modification timestamp in your database, you can either increase the <code class="code docutils literal notranslate"><span class="pre">updateRate</span></code> or manage a custom modification time inside your <code class="code docutils literal notranslate"><span class="pre">SuggestDataProvider</span></code> implementation that might only be incremented every N hours.</p>
<p>When loading data, the <code class="code docutils literal notranslate"><span class="pre">SuggestDataProvider</span></code> implementation needs to produce all suggest records at once and provide a single big <code class="code docutils literal notranslate"><span class="pre">SuggestData</span></code> object. Here an example what goes into that DTO:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">SuggestData</span><span class="w"> </span><span class="n">suggestDTO</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SuggestData</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>

<span class="w">        </span><span class="c1">// the type will be attached to every suggestion coming from this data provider</span>
<span class="w">        </span><span class="p">.</span><span class="na">type</span><span class="p">(</span><span class="s">&quot;product&quot;</span><span class="p">)</span>

<span class="w">        </span><span class="c1">// the locale is used for several normalisation during index time are done</span>
<span class="w">        </span><span class="p">.</span><span class="na">locale</span><span class="p">(</span><span class="n">Locale</span><span class="p">.</span><span class="na">GERMAN</span><span class="p">)</span>

<span class="w">        </span><span class="c1">// this is where the actual suggest records are loaded and passed to the DTO</span>
<span class="w">        </span><span class="p">.</span><span class="na">suggestRecords</span><span class="p">(</span><span class="n">loadSuggestions</span><span class="p">())</span>

<span class="w">        </span><span class="c1">// The same timestamp has to be set here, as returned by `getLastDataModTime(String indexName)`</span>
<span class="w">        </span><span class="p">.</span><span class="na">modificationTime</span><span class="p">(</span><span class="n">getModificationTime</span><span class="p">())</span>

<span class="w">        </span><span class="c1">// If available, it&#39;s also possible to add stop-words that will be ignored during indexing.</span>
<span class="w">        </span><span class="p">.</span><span class="na">wordsToIgnore</span><span class="p">(</span><span class="n">Set</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="s">&quot;this&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;that&quot;</span><span class="p">))</span>

<span class="w">        </span><span class="p">.</span><span class="na">build</span><span class="p">();</span>
</pre></div>
</div>
</section>
<section id="monitoring">
<h2>Monitoring<a class="headerlink" href="#monitoring" title="Link to this heading"></a></h2>
<p>smartSuggest, optionally, provides internal metrics using the <a class="reference external" href="https://micrometer.io/">Micrometer</a> framework. If you’d like to tap into those metrics, simply add the necessary Micrometer connector to your dependencies followed by, your desired MeterRegistry.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="w"> </span><span class="c1">// ...</span>
<span class="w"> </span><span class="n">MeterRegistry</span><span class="w"> </span><span class="n">meterRegistry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getYourMeterRegistryInstance</span><span class="p">();</span>

<span class="w"> </span><span class="c1">// example: to reveal metrics over JMX create a JmxMeterRegistry</span>
<span class="w"> </span><span class="n">meterRegistry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">JmxMeterRegistry</span><span class="p">(</span><span class="n">JmxConfig</span><span class="p">.</span><span class="na">DEFAULT</span><span class="p">,</span><span class="w"> </span><span class="n">Clock</span><span class="p">.</span><span class="na">SYSTEM</span><span class="p">);</span>

<span class="w"> </span><span class="c1">// and add it to the QueryMapperManager.builder afterwards</span>
<span class="n">QuerySuggestManager</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>
<span class="w">   </span><span class="c1">// ...</span>
<span class="w">   </span><span class="p">.</span><span class="na">addMetricsRegistryAdapter</span><span class="p">(</span><span class="n">MeterRegistryAdapter</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">meterRegistry</span><span class="p">));</span>
<span class="w">   </span><span class="c1">// ...</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="service-operations.html" class="btn btn-neutral float-left" title="Service Operations" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="changelog.html" class="btn btn-neutral float-right" title="Changelog" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright , CXP Commerce Experts GmbH.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>